---
title: 存储类别
tags:
  - C
categories:
  - Language
  - C
---
# 变量的存储类别

## 总结

- storage duration → scope → linkage

- 对象（object）：用来存储值的一块内存。


- 标识符（identifier）：标识内存块的符号


- 左值（lvalue），可修改的左值（modifiable lvalue）。标识符是左值。

- 赋值操作只能发生在函数内，不能发生在函数外
- extern 用于声明而非定义
- 翻译单元。头文件+C代码文件，即预编译后的文件

| 链接(linkage)                      | 作用域(scope)                                                | 存储期(scope duration)              |
| ---------------------------------- | ------------------------------------------------------------ | ----------------------------------- |
| 无链接(none linkage)               | 块作用域(block scope)、函数原型作用域(function prototype scope)、函数作用域(function scope) | 自动存储期(auto)/静态存储期(static) |
| 内部链接(internal linkage)(static) | 内部链接的**文件作用域**(file scope with internal linkage)/文件作用域(file scope) | 静态存储期                          |
| 外部链接(external linkage)(extern) | 外部链接的**文件作用域**(file scope with external linkage)/程序作用域(program scope)/全局作用域(global scope) | 静态存储期                          |

|              | 存储期 | 作用域 | 链接 | 声明方式           |
| ------------ | ------ | ------ | ---- | ------------------ |
| 自动         | 自动   | 块     | 无   | 块内               |
| 寄存器       | 自动   | 块     | 无   | 块内，register     |
| 静态外部链接 | 静态   | 文件   | 外部 | 所有函数外         |
| 静态内部链接 | 静态   | 文件   | 内部 | 所有函数外，static |
| 静态无连接   | 静态   | 块     | 无   | 块内，static       |

## 作用域scope

作用域：标识符可被访问的程序范围。由compiler处理

翻译单元（translation unit）：预编译后的 头文件+c源码文件

- 块的定义和块作用域
    - 块作用域（block scope）1：被花括号括起来的部分被称为块（block）；在块里声明的变量，在块以外就无法访问，编译器编译时会提示 undeclared；
    - 块作用域2：函数头里声明的形式参数与函数体里的变量同属一个函数块。
        - C99新特性1：可在块中任意位置声明变量，C99以前只能在块开头的地方声明；
        - C99新特性2：循环语句（for, while, do...while）和 if 语句自成一个块，即使这些语句没有花括号；循环体是循环块的子块，循环头是循环块，if 语句同理。
    - 块作用域3：普通块，语句块（c99 新增：while, do...while, for, if 块），函数块。
- 嵌套：
    - 嵌套隐藏：块里再嵌套块，被嵌套的块是子块（sub-block）；如果内层块与外层块声明了**同名变量**，执行进内层块的时候，外层同名变量会被隐藏；
    - 循环体是整个**循环块**的子块，if 执行语句是整个 **if 块**的子块
    - 函数定义不同。函数头与函数体同级，同属一个**函数块**，函数形参在函数体里不会被隐藏。

- 函数作用域（function scope）仅用于 goto 语句的标签。
- 函数原型作用域（function prototype scope）：用于函数原型中的形参名；范围是从声明处到函数原型结束；所以函数原型中的形参名通常无关紧要。
- 文件作用域（file scope）/全局变量（global variable）：在函数外声明的变量。

## 链接linkage
由linker处理

翻译单元（translation unit）：预编译后的 头文件+c源码文件
- 无连接：不能被其它文件引用。具有**块作用域**、**函数作用域**、**函数原型作用域**的变量都是无链接变量。
- 内部链接（外部链接的文件作用域）：只能用在**当前翻译单元**，引用时不需要声明；定义式声明前加关键字 static；简称为全局作用域/程序作用域；

- 外部链接（内部链接的文件作用域）：能作用于**多个翻译单元**；简称为文件作用域；
  - 定义时不加 extern；同一翻译单元内引用无须用 extern 声明，在其它翻译单元引用时要用extern引用式声明


```c
int giants = 5;  //外部链接
static int dodgers = 3;  //内部链接
int main(void)
{
	...
}
...
```

## 存储期 storage duration

### 总结

链接描述了能通过标识符访问对应对象的范围，存储期描述了对象的存续时间。

- 静态存储期：在整个程序运行期间一直存在；在变量声明前加 static 关键字就可声明静态存储期变量；文件作用域变量都具有静态存储期，static 关键字只表明该变量是内部链接变量；定义在函数体内的静态变量一直存在，但其他函数不能直接**访问**，可以通过返回值或地址间接访问；

- 线程存储期：从被声明到线程结束，一直存在；以关键字 `_Thread_local` 声明一个对象时，每个线程都获得该变量的私有拷贝；

- 自动存储期：块作用域变量都具有自动存储期 (auto)，进入块时为变量分配对象，块结束处会释放变量，**变长数组**从声明处到块的末尾；

- 动态分配存储期：

- 5 种混合存储类别：

  | 类型         | 存储期 | 作用域 | 链接 | 声明方式            |
  | ------------ | ------ | ------ | ---- | ------------------- |
  | 自动         | 自动   | 块     | 无   | 块内                |
  | 寄存器       | 自动   | 块     | 无   | 块内，register      |
  | 静态外部链接 | 静态   | 文件   | 外部 | 所有函数外          |
  | 静态内部链接 | 静态   | 文件   | 内部 | 所有函数外，static  | 
  | 静态无连接   | 静态   | 块     | 无   | 块内，static        |


### 自动变量

- 自动变量：块作用域、自动存储期、无链接

- 嵌套隐藏：块里再嵌套块，被嵌套的块是子块（sub-block）；如果内层块与外层块声明了**同名变量**，执行进内层块的时候，外层同名变量会被隐藏；
  - 循环体是整个**循环块**的子块，if 执行语句是整个 **if 块**的子块
  - 函数定义不同。函数头与函数体同级，同属一个**函数块**，函数形参在函数体里不会被隐藏。
- 声明自动变量：1. 在块里声明的变量默认为自动变量；2. 显示声明可用 auto 关键字在声明前，但与 c++ 会冲突。

### 寄存器变量

- 声明方式：前加 register 关键字，eg:

  ```c
  int main(void)
  {
  	register int quick;
  	...
  	return 0;
  }
  void macho(register int n)
  {
  ...
  }
  ```

- 寄存器变量不能通过地址访问，只能通过变量名访问；
- 寄存器变量也是块作用域、静态存储期、无链接；
- 寄存器变量不一定在寄存器里，看请求是否被批准；寄存器不一定存得下 double 等变量；

### 块作用域的静态变量

静态变量（static variable），块作用域（block scope）

- 定义：在花括号（包括函数）内用 static 声明的变量；不能在函数形参里使用static；
- 静态指在程序运行期间一直存在；又叫局部静态变量；
- 在函数体内声明初始化块作用域静态变量的语句，只在程序被载入内存时执行一次，程序运行时不会执行；

### 外部链接的静态变量

#### 定义与声明

外部链接的静态变量 (static variables with external linkage)具有文件作用域、外部链接、静态存储期；

该类别有时被称为外部存储类别 (external storage class)，属于该类别的变量被称为**外部变量 (external variables)**；

- 定义：在所有函数外定义的变量就是外部变量；
- 声明：要使外部变量被其它文件可用，就要用 extern 声明；本文件里可声明可不声明；
- 隐藏：在函数内不加 extern 定义自动存储期同名变量，编译器会隐藏外部变量；
- 位置：在定义/声明后的函数才可用外部变量；

```c
int Errupt;
double Up[100];
void next(void);
int main(void)
{
    extern int Errupt;  //可选声明
    extern double Up[];  //可选声明，不用指定数组大小
	...
}
void next(void)
{
	...
}
```

#### 1. 初始化外部变量

只能用常量表达式初始化文件作用域变量；如果未被初始化，会被自动初始化为0

#### 2. 使用外部变量

#### 3. 外部名称

旧标准：编译器识别局部标识符前 31 个字符、外部标识符前 6 个字符；

C99 和 C11 标准：编译器识别局部标识符前 63 个字符、外部标识符前 31 个字符；

#### 4. 定义和声明

定义和声明都是声明；

定义：定义式声明 (difining declaration)，为变量预留内存空间，**不能用 extern 进行定义式声明**，定义式声明只能有一个；

声明：引用式声明 (referencing declaration)，告诉编译器将使用该变量，**extern 只能用在引用式声明**，引用式声明可以有多个；

在整个程序中，只能在一个文件里并初始化一次；**但是可以为外部变量随意赋值**。

### 内部链接的静态变量

内部链接的静态变量 (static variables with internal linkage)：文件作用域、内部链接、静态存储区；

这种变量也被称为**外部静态变量 (external static variables)**

定义方式：用 static 关键字在所有函数外定义该变量，eg：

```c
static int svil = 1;
int main(void)
{
	...
}
```

### 存储类别说明符

6 个存储类别说明符：auto, static, extern, register, _Thread_local, typedef;

| 说明符 | 作用 |
| ------ | ---- |
| auto   |      |
| static |      |
| extern |      |

# 函数的存储类别

函数也有存储类别：外部函数（默认）、静态函数、内联函数（C99 新增）；

```c
double gamma(double);  //默认为外部函数
static double beta(int, int);  //静态函数
extern double delta(double, int);  //外部函数
```

外部函数（默认、extern 声明）可以被其他文件访问；内部函数（static 声明）只能用于其定义所在的文件，避免函数名重复。

